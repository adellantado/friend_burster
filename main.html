<!DOCTYPE html>
<html>
<head>
	<script src="http://code.createjs.com/easeljs-0.6.0.min.js"></script>
	<script src="http://code.createjs.com/tweenjs-0.4.0.min.js"></script>
	<script src="http://code.createjs.com/soundjs-0.4.0.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="game.js"></script>
</head>
<body onload="init();">

<div id="vk_api_transport"></div>
<script type="text/javascript">

		var xhrs = {};

		setTimeout(function () {
			var el = document.createElement('script');
			el.type = 'text/javascript';
			el.src = "http://vk.com/js/api/openapi.js";
			el.async = true;
			document.getElementById('vk_api_transport').appendChild(el);
		}, 0);


		window.vkAsyncInit = function () {
			VK.init({
				apiId: 3550061
			});
			getStatus();
		};

		function getStatus() {
			VK.Auth.getLoginStatus(function (response) {
				if (response.session) {
					getUserSettings(response);
				} else {
					login();
				}
			});
		}

		function getUserSettings(response) {
			VK.Api.call('getUserSettings', {}, function (res) {
				var settings = res.response;
				console.log("settings: " + settings);
				if (settings >= 2) {
					getFriends();
				} else {
					login();
				}
			});
		}

		function login() {
			VK.Auth.login(authInfo, 1 + 2);
			console.log("login");
		}

		function authInfo(response) {
			console.log("sid: " + response.session.sid);
			getFriends();
		}

		function getFriends() {
			VK.Api.call("friends.get" ,{fields: "uid, first_name, last_name, photo"},function(res) {
				friends = res.response;
				url = "http://lamour.in.ua/html5/download.php?download=";
				for (var i = 0; i < friends.length; i++) {
					xhrs[friends[i].uid] = friends[i];
				}
				loadNext(friends[0]);
				//preloadImage(friends[Math.round(Math.random()*(friends.length-1))]);
			});
		}

		var i = 0;
		function loadNext(friend) {
			var xhr = $.ajax({type: 'GET',
            						url: 'download.php',               
						            data: {download: friend.photo},
						            async: true,
						            success: function(res,status,xhr){
						            	i++;
						            	xhrs[xhr.id].photo = res;
						            	if (i == friends.length) {
						            		preloadImage(friends[Math.round(Math.random()*(friends.length-1))]);
						            	} else {
						            		loadNext(friends[i]);
						            	}
						            }});
			xhr.id = friend.uid;

		}

		function callBack(res,status,xhr) {
			xhrs[xhr.id].photo = res;
		}

		/*friends = [{photo: "x_87b606ea.jpg", id: 0}, 
			   {photo: "x_87b606ea.jpg", id: 1}, 
			   {photo: "x_87b606ea.jpg", id: 2}];*/

</script>

<div class="canvasHolder">
	<canvas id="canvas" width="600" height="530"></canvas>
</div>

</body>
</html>