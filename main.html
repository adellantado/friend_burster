<!DOCTYPE html>
<html>
<head>
	<!--<script src="http://code.createjs.com/easeljs-0.6.0.min.js"></script>-->
	<!--<script src="http://code.createjs.com/tweenjs-0.4.0.min.js"></script>-->
	<!--<script src="http://code.createjs.com/soundjs-0.4.0.min.js"></script>-->
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="game.js"></script>
	<script type="text/javascript" src="http://vkontakte.ru/js/api/share.js?9" charset="windows-1251"></script>

	<style type="text/css">

		#main {
			position:absolute;
			top: 0;
			left: 0;
			bottom: 0;
			width: 100%; 
			height: 100%;
			background-size: 100% 100%;
			background-position: left top;
			background-repeat: no-repeat;
			background-image: url("assets/background.png");
		}

   		#w3org {
   			position: absolute;
   			left: 20px;
   			bottom: 20px;
   		}
   		
		#canvas
		{
		    display: block;
		    margin: 80px auto;
		}

	</style>

</head>
<body onload="start();">

<script src="src/createjs/events/EventDispatcher.js"></script>
<script src="src/createjs/events/Event.js"></script>

<script src="src/easeljs/events/MouseEvent.js"></script>
<script src="src/easeljs/geom/Matrix2D.js"></script>
<script src="src/easeljs/geom/Rectangle.js"></script>
<script src="src/easeljs/utils/UID.js"></script>
<script src="src/easeljs/utils/Ticker.js"></script>
<script src="src/easeljs/display/DisplayObject.js"></script>
<script src="src/easeljs/display/Container.js"></script>
<script src="src/easeljs/display/Stage.js"></script>
<script src="src/easeljs/display/Graphics.js"></script>
<script src="src/easeljs/display/Shape.js"></script>
<script src="src/easeljs/display/Text.js"></script>
<script src="src/easeljs/display/Bitmap.js"></script>
<script src="src/easeljs/display/SpriteSheet.js"></script>
<script src="src/easeljs/display/Sprite.js"></script>

<script src="src/createjs/utils/IndexOf.js"></script>
<script src="src/createjs/utils/Proxy.js"></script>
<script src="src/soundjs/Sound.js"></script>
<script src="src/soundjs/WebAudioPlugin.js"></script>

<script src="src/tweenjs/Tween.js"></script>

<div id="vk_api_transport"></div>
<script type="text/javascript">

    var isDev = true;

        if (!isDev) {

            setTimeout(function () {
                var el = document.createElement('script');
                el.type = 'text/javascript';
                el.src = "http://vk.com/js/api/openapi.js";
                el.async = true;
                document.getElementById('vk_api_transport').appendChild(el);
            }, 0);


            window.vkAsyncInit = function () {
                VK.init({
                    apiId: 3713268
                });
                getStatus();
            };

        }




		function start() {

            if (isDev) {
                friends = [];
                var friend = {uid: 0, photo: 'assets/photo.jpg'};
                friends.push(friend);
                preloadImage(friend);
                init();
                return;
            }

            var shareButton = VK.Share.button({
                title: 'Friend Burster',
                description: 'awesome. check this out!',
                image: 'http://beedevs.com/friend_burster/preview.png',
                noparse: true
            }, {type: 'custom',
                text: '<img src="http://vk.com/images/vk16.png"/>'
            });
            var div = document.getElementById('vk_share_button');
            div.innerHTML = shareButton;

			init();
		}

		function getStatus() {
			VK.Auth.getLoginStatus(function (response) {
				if (response.session) {
					getUserSettings(response);
				} else {
					login();
				}
			});
		}

		function getUserSettings(response) {
			VK.Api.call('getUserSettings', {}, function (res) {
				var settings = res.response;
				console.log("settings: " + settings);
				if (settings >= 2) {
					getFriends();
				} else {
					login();
				}
			});
		}

		function login() {
			VK.Auth.login(authInfo, 1 + 2);
			console.log("login");
		}

		function authInfo(response) {
			console.log("sid: " + response.session.sid);
			getFriends();
		}

		function getFriends() {

			VK.Api.call("friends.get" ,{fields: "uid, first_name, last_name, photo"},function(res) {
				//friends = res.response;
				friends = [];
				// worker
				var loadWorker = new Worker("load_photos_worker.js");
				loadWorker.onerror = function (event) {
					console.log("Worker error: "+event.message);
				}
 				loadWorker.onmessage = function (event) {
 					var friend = event.data.friend;
 					if (friend) {
 						friends[friends.length] = friend;
 						console.log("Friend loaded: "+friend.uid);
						preloadImage(friend);
 					}
				}
				loadWorker.postMessage({friends: res.response});
			});
		}

</script>
<div id="main" class="canvasHolder">
	<div id="vk_share_button" height="50"></div>
	<a href="http://www.w3.org/html/logo/" target="_blank">
		<img id="w3org" src="http://www.w3.org/html/logo/badge/html5-badge-h-css3-graphics-performance.png" width="197" height="64" alt="HTML5 Powered with CSS3 / Styling, Graphics, 3D &amp; Effects, and Performance &amp; Integration" title="HTML5 Powered with CSS3 / Styling, Graphics, 3D &amp; Effects, and Performance &amp; Integration">
	</a>
    <canvas id="canvas" width="600" height="530"></canvas>
</div>


</body>
</html>